<html>
<head>
  <title> RFT Service </title>
</head>

<body>

<img border="0" src="globus_top.gif" width="505" height="32"><br>
<img border="0" src="globus.gif" width="134" height="38"><img border="0" src="ogsadf.gif" width="530" height="34"><br>
<img border="0" src="globus_bottom.gif" width="100" height="32">

<h1>Reliable File Transfer Service - Alpha</h1>

<!-- --------------------------- -->
<h3>Overview</H3>
<p>The Reliable Transfer Service (RFT) is an OGSA based service that
provides interfaces for controling and monitoring 3rd
party file transfers using GridFTP servers.
The client controlling the transfer is hosted inside of a grid service so it can
be managed using the soft state model and queried using the ServiceData interfaces
available to all grid services.
It is esentially a reliable and recoverable version
of the GT2 globus-url-copy tool.

<!-- --------------------------- -->
<H3>Prerequisites and Dependencies</H3>
<P>
The Prerequisites to RFT are:
<ul>
	<li><B>Core Alpha Distribution</B>
	<li><B>GridFTP</B> with a properly configured <B>Host Certificate</B>
	<LI><B>PostgreSQL</B>
</UL>
<p><B>PostgreSQL</B> is used to store   
the state of the transfer to allow for restart after failures.
The interface to PostgreSQL is JDBC so any DBMS that supports JDBC can be used, although 
no other has been tested.
<P>
<B>GridFTP</B> perfoms the actual file transfer.
<p>GridFTP server can only be run on Unix or Linux.
There are 2 ways to get GridFTP: 
<OL>
<LI>Packaged with the core GT3 Alpha installation.
<LI>As part of the Globus Toolkit 2.2 distribution.
</OL>
If you don't already have GridFTP from GT2 installed, use the GT3 bundled version.
In either case, configuration instructions are documented below.


<!-- ====================================== -->
<h2>PostgreSQL Setup</h2>
PostgreSQL can be installed both on Unix and on Windows. For detailed Unix
instructions see: 
<a href="http://www3.us.postgresql.org/sitess.html" EUDORA="AUTOURL">http://www3.us.postgresql.org/sitess.html</a>
and for more detailed Windows instructions see: <a href="http://www.ejip.net/faq/postgresql_win_setup_faq.jsp">http://www.ejip.net/faq/postgresql_win_setup_faq.jsp</a>
(Only the first four steps are needed). Here is a summary of what you need to do
after installation:

<!-- --------------------------- -->
<h3>Unix Specific Setup</h3>
Login as root.
<pre>
    adduser postgres
    mkdir /usr/local/pgsql/data
    chown postgres /usr/local/pgsql/data
    su - postgres
</pre>

<!-- --------------------------- -->
<h3>Windows Specific Setup</h3>
To run postgreSQL under Windows you need to install <a href="http://www.cygwin.com">Cygwin</a>,
and enable at least the following features:<br>
Database-&gt;postgresql<br>
Utils-&gt;bzip2<br>
Base-&gt;libreadline5<br>
<br>
After installing these components you also need to install CygIPC: <a href="http://www.neuro.gatech.edu/users/cwilson/cygutils/cygipc/index.html">http://www.neuro.gatech.edu/users/cwilson/cygutils/cygipc/index.html</a>
<p>Now start the ipc_daemon from a cygwin shell e.g:
<PRE>
    /cygdrive/c/cygwin/usr/local/bin/ipc-daemon.exe &amp;</p>
</PRE>
<p>That's it, now you should be able to use psql and postgres as if on a Unix
machine. Note however that you will be using the username 'Administrator' as
opposed to 'postgres'</p>

<!-- --------------------------- -->
<h3>Common Setup</h3>
<p>After completing either the Unix or Windows specific setup above do the
following from your user shell (postgres or Administrator).
<pre>
    export PGDATA=/usr/local/pgsql/data
    initdb
    createdb ogsa
    psql -d ogsa -f rft_schema_ogsa.sql
</pre>
(rft_schema_ogsa.sql is provided in the ogsa distribution root, under the etc directory)
<p>
To start the db server run:
<PRE>
    pgctl -o&nbsp; &quot;-i&quot; -l logfile start
</pre>


<!-- ====================================== -->
<a name="gridftp"><h2>Configure and Run a GridFTP Server</h2></a>

Typically two GridFTP servers on separate machines are used to perform a file transfer.
However to perform a simple test of RFT, one GridFTP server is sufficient.
Another alternative is to start two GridFTP servers 
on one machine using different ports.
<P>
A properly installed <B>Host Certificate</B> is required to run GridFTP.
See the Alpha Admin Guide, Security Configuration for details.


<!-- --------------------------- -->
<H3>Run a GridFTP Server</H3>

<B>As root</B>, start a GridFTP server as follows:
<PRE>
    $GLOBUS_LOCATION/sbin/in.ftpd -S [-p &lt;port&gt;]</p>
</PRE>
GLOBUS_LOCATION is an environment variable set to the root directory of your Globus Core Installation.

<P>
The "-S" will send the process to the background.
<BR>
The -p specifies an available port that GridFTP will listen on. If it's in use, try another.
<p>
<b>Testing GridFTP - Moving a test file</b>
<p>Create a file named <code>/tmp/file1</code>
and run the following command:
<pre>
    globus-url-copy -s &quot;`grid-cert-info -subject`&quot; \
        gsiftp://localhost:5678/tmp/file1 \
        file:///tmp/file2
</pre>
<p>Check to make sure that /tmp/file2 now exists.

<!-- --------------------------- -->
<H3>Configure a GridFTP Server</H3>
<P>If you want a GridFTP server to be started automatically when requests come in
over a particular socket, then configure your system as follows.
Otherwise, this step may be ignored.
<P>
If you already have a GT2 GridFTP server installed, skip this step.
<p>
Make the following changes to your system as root.

<p>Add this entry to /etc/services:

<pre>
   gsiftp  2811/tcp
</pre>

<p>Depending on whether your host is running inetd or xinetd, you will need to modify
its configuration accordingly. 

<ul>
<p><b>Inetd</b><br>
  Add the following entry, all on one line, to /etc/inetd.conf.
  Replace GLOBUS_LOCATION below with the actual value of $GLOBUS_LOCATION in your
  environment. </p>
  <pre>
    gsiftp  stream  tcp     nowait  root
      /usr/bin/env env LD_LIBRARY_PATH=GLOBUS_LOCATION/lib
      GLOBUS_LOCATION/sbin/in.ftpd -l -a -G GLOBUS_LOCATION
</pre>
<p><b>New to 2.2:</b> This entry has changed from the
entry provided for the GridFTP server in the Globus Toolkit 2.0 Administrator's
Guide.&nbsp; The reason is that if you followed the instructions from the install section,
you do not have a static in.ftpd.&nbsp; This requires you to set the LD_LIBRARY_PATH so
that the server can dynamically link against the libraries in $GLOBUS_LOCATION/lib.&nbsp;
To accomplish the setting of the environment variable in inetd, we use /usr/bin/env (the
location may vary on your system) to first set LD_LIBRARY_PATH, and then to call in.ftpd
itself.
<p>
The advantage of this setup is that when you apply a security update to your
installation, the GridFTP server will pick it up dynamically without your having to
rebuild it. </p>
<p>
<b>Xinetd</b><br>
For xinetd, add a file named &quot;grid-ftp&quot; to the /etc/xinetd.d/ directory with 
the following contents. Be sure to replace GLOBUS_LOCATION below with the actual value
of $GLOBUS_LOCATION in your environment.
<pre>
    service gsiftp
    {
	    instances               = 1000
	    socket_type             = stream
	    wait                    = no
	    user                    = root
	    env			    = LD_LIBRARY_PATH=GLOBUS_LOCATION/lib
	    server                  = GLOBUS_LOCATION/sbin/in.ftpd
	    server_args             = -l -a -G GLOBUS_LOCATION
	    log_on_success         += DURATION USERID
	    log_on_failure         += USERID
	    nice                    = 10
            disable                 = no
    }
</pre>
  <p><b>New to 2.2:</b> This entry has changed from the
  entry provided for the GridFTP server in the Globus Toolkit 2.0 Administrator's
  Guide.&nbsp; The reason is that if you followed the instructions from the install section,
  you do not have a static in.ftpd.&nbsp; This requires you to set the LD_LIBRARY_PATH so
  that the server can dynamically link against the libraries in $GLOBUS_LOCATION/lib.&nbsp;
  To accomplish the setting of the environment variable in xinetd, we use the &quot;env
  =&quot; option to set LD_LIBRARY_PATH in the gatekeeper's environment. </p>
  <p>The advantage of this setup is that when you apply a security update to your
  installation, the GridFTP server will pick it up dynamically without your having to
  rebuild it. </p>
</ul>

<p>The -G GLOBUS_LOCATION (remember to substitute your real GLOBUS_LOCATION) tells the
in.ftpd to look for ftpaccess in $GLOBUS_LOCATION.&nbsp; If you do not specify this flag,
the server will use /etc/ftpaccess. </p>

<p>After you have added the gridftp service to either inetd or xinetd, 
notify inetd (or xinetd) that its configuration file has changed as follows:

<ul>
  <p><b>For Inetd:</b><br>
  On most linux systems, you can simply run `killall -HUP inetd` </p>
  <p>On other systems, the following has the same effect: ps aux | grep inetd | awk '{print
  $2;}' | xargs kill -HUP </p>
  <p><b>For Xinetd:</b><br>
  On most linux systems, you can simply run `/etc/rc.d/init.d/xinetd restart` </p>
  <p>On other systems (or if that doesn't work), see man xinetd. </p>
</ul>

<p>GridFTP uses /etc/grid-security/grid-mapfile for authorization, just like GRAM.</p>


<!-- ====================================== -->
<h2>RFT Grid Service Setup</h2>

<P>
The Core Alpha distributions includes the a deployable GAR for RFT named <CODE>reliabletransfer.gar</CODE>.
<p>First, set the following parameters in reliabletransfer-server-config.wsdd:
<BR>
<b>&nbsp;JdbcDriver</b> : Name of the JDBC Driver for the database you want to
use. For a PostgreSQL installation as described above this value is:
org.postgresql.Driver. The driver is shipped along with our distribution.<br>
<b>connectionURL</b>: URL for the Database in order make the connection. For
postgres this is jdbc:postgresql:&lt;db&gt;, and in our example above it would
be jdbc:postgresql:ogsa
<br>
<b>username</b>: Local user with access to the database. (On windows this would
be Administrator)
<br>
<b>password</b>: Password set up to access the database for the particular user.
<P>
Deploy the gar by running the following command in $GLOBUS_LOCATION: 
<pre>
    ant -f build-packages.xml deployClientServerGar -Dgar.name=&lt;location of reliabletransfer.gar&gt;
</pre>

<H3>Build the GAR from Source Distribution</H3>
This step is optional.
<p>
If you downloaded the RFT source code then you can make a deployable gar file as follows: 
<BR>
Change the ogsacore.javadir property in build.xml to point to ogsa/impl/java directory
in your  ogsa installation (or you can override the default property by doing
 ant -Dogsacore.dir=&lt;your ogsa installation&gt; compile)
<BR>
Run:
<pre>
    cd data_management/filetransfer/rft
    ant stubs
    ant gar
</pre>
This builds a gar that can be deployed in a service container. Now update the reliabletransfer-server-config.wsdd
and deploy the GAR as described above.


<!-- ====================================== -->
<h2>Testing the RFT Service using the ServiceBrowser Client</h2>

1. There are dynamic GUI panels available which plug into the ServiceBrowser.
Add the following panel definitions to the client-gui-config.xml file.
Note that the file is located in ogsa/impl/java as well as in the ogsa.jar and the ServiceBrowser 
will find the file based on CLASSPATH. 
<PRE>
  &lt;panel portType="ReliableTransferPortType"
    class="org.globus.ogsa.gui.ReliableTransferPortTypePanel"/&gt;
  &lt;panel serviceData="FileTransferProgress"
    class="org.globus.ogsa.gui.FileTransferProgressServiceDataPanel"/&gt;
  &lt;panel serviceData="FileTransferRestartMarker"
    class="org.globus.ogsa.gui.FileTransferRestartMarkerServiceDataPanel"/&gt;
</PRE>
Without these definitions the ServiceBrowser will return a default RFT panel 
which won't work.
<BR>
2. Run "ant gui" from the install-root directory.
<BR>
3. Double click on the Deactivated RFT Factory instance that is listed in the
ServiceBrowser ContainerRegistryService
<br>
4. Create an Instance of RFT from the RFT Factory.
<br>
5. In the RFT GUI fill in From URL / To URL with valid GridFTP URLs in this format:
<PRE>
    gsiftp://hostname:port/filename
</PRE>
The hostname:port should correspond with the running GridFTP servers.
<br>
6.You can also specify number of parallel streams per transfer and set the TCP
Buffer size for the transfer
<br>
7.Enable XML Signature/Encryption and Check Delegate Credentials check box.
<br>
8.Submit Transfer.
<br>
9. RFT is a persistent Reliable Transfer Service so if the service container
goes down while a transfer is in process the transfer will be restarted the next time you
start the service container when you activate the persistent instance.


<!-- ====================================== -->
<h2>Service Data Elements for RFT</h2>
The percentage of file that has been transferred is exposed as Service Data.
The percentage is calculated in two ways: 
<OL>
<LI>Using performance markers
<LI>Using the restart markers that are obtained during the course of the transfer.
</OL>
In the RFT GUI there are two panels with JProgressBars indicating the percentage of file
that has been transferred.
<br>
Performance markers and restart markers are check points 
that are given out by GridFTP servers indicating how much data has been transferred.
The Restart Markers are used to restart the transfer from that check point.
Performance Markers contain additional performance information.
</body>
</html>
