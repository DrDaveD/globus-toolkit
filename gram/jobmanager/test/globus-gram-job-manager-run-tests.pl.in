#! /usr/bin/env perl

BEGIN { push(@INC, $ENV{GLOBUS_LOCATION} . "/lib/perl"); }

use strict;
use Test::Harness;
require 5.005;
use vars qw(@tests);
use Globus::Core::Paths;

$|=1;

my $contact;
my $startargs = '-log never ';

@tests = qw(
    globus-gram-job-manager-stdio-test.pl
    globus-gram-job-manager-submit-test.pl
    globus-gram-job-manager-failure-test.pl
);
if(0 != system("grid-proxy-info -exists -hours 2") / 255)
{
    print STDERR "Security proxy required to run the tests.\n";
    exit 1;
}

chdir $Globus::Core::Paths::exec_prefix . "/test/@PACKAGE@";

if(@ARGV)
{
    $startargs .= join(' ', @ARGV);
}

if(exists($ENV{CONTACT_STRING}))
{
    print "Using gatekeeper at " . $ENV{CONTACT_STRING} . "\n";
}
else
{
    my $personal_gatekeeper = $Globus::Core::Paths::bindir
                            . "/globus-personal-gatekeeper";
    system("$personal_gatekeeper -killall >/dev/null 2>/dev/null");
    system("$personal_gatekeeper -start $startargs >/dev/null 2>/dev/null");
    chomp($contact = `$personal_gatekeeper -list`);
    if($? != 0)
    {
	print "Could not start gatekeeper\n";
	exit 1;
    }
    $ENV{CONTACT_STRING} = $contact;
}

runtests(@tests);

sub END {
system("globus-personal-gatekeeper -kill \"$contact\" >/dev/null 2>/dev/null");
}
