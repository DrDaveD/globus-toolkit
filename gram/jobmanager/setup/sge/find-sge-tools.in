## Required Prolog

AC_REVISION($Revision$)
AC_INIT(sge.in)


##########
## checking for the GLOBUS_LOCATION
##
if test "x$GLOBUS_LOCATION" = "x"; then
    echo "ERROR: Please specify GLOBUS_LOCATION" >&2
    exit 1
fi


##########
## Check if SGE_ROOT is properly defined
##
if test "x$SGE_ROOT" = "x"; then
    echo "ERROR: Please specify SGE_ROOT" >&2
    exit 1
fi

if test "x$SGE_CELL" = "x"; then
    SGE_CELL=default
fi

if test ! -d $SGE_ROOT/$SGE_CELL ; then
    echo "ERROR: \${SGE_ROOT}/\${SGE_CELL} should to be a directory"
    echo "       $SGE_ROOT/$SGE_CELL is not!"
    exit 1
fi

AC_SUBST(SGE_ROOT)
AC_SUBST(SGE_CELL,$SGE_CELL)


##########
## Check for optional tools, warn if not found
##

## Junk file is for temporary results
JUNK=${TMPDIR:-/tmp}/globus_sge_integration_sunmpicheck.$$

## We'll need AWK
AC_PROG_AWK

## mpirun
AC_PATH_PROG(MPIRUN, mpirun, no)
if test "$MPIRUN" = "no" ; then
    AC_MSG_WARN([Cannot locate mpirun])
fi


##########
## Check for Sun's MPI implementation
##
AC_PATH_PROG(SUN_MPRUN, mprun, no)
if test "$SUN_MPRUN" = "no" ; then
    AC_MSG_WARN([Sun MPI not available])
fi

## To ignore sunmpi or not?
if test "$IGNORE_SUNMPI" = "yes" && "SUN_MPRUN" != "no" ; then
    AC_MSG_WARN([Ignoring Sun HPC ClusterTools (tm)])
    SUN_MPRUN=no
fi
AC_SUBST(SUN_MPRUN)


##########
## Checking for cat (needed for job arrays)
##
AC_PATH_PROG(CAT, cat, no)
if test "$CAT" = "no" ; then
    AC_MSG_ERROR([Cannot locate bin])
fi
AC_SUBST(CAT)


##########
## What is the default MPI PE
##
AC_SUBST(MPI_PE)


##########
## Check for Sun Grid Engine tools
##
AC_PATH_PROG(QSUB, qsub, no)
if test "$QSUB" = "no" ; then
    AC_MSG_ERROR([Cannot locate qsub])
fi
AC_PATH_PROG(QSTAT, qstat, no)
if test "$QSTAT" = "no" ; then
    AC_MSG_ERROR([Cannot locate qstat])
fi
AC_PATH_PROG(QDEL, qdel, no)
if test "$QDEL" = "no" ; then
    AC_MSG_ERROR([Cannot locate qdel])
fi
AC_PATH_PROG(QSELECT, qselect, no)
if test "$QSELECT" = "no" ; then
    AC_MSG_ERROR([Cannot locate qselect])
fi
AC_PATH_PROG(QHOST, qhost, no)
if test "$QHOST" = "no" ; then
    AC_MSG_ERROR([Cannot locate qhost])
fi
AC_PATH_PROG(QCONF, qconf, no)
if test "$QCONF" = "no" ; then
    AC_MSG_ERROR([Cannot locate qconf])
fi
AC_PATH_PROG(QACCT, qacct, no)
if test "$QACCT" = "no" ; then
    AC_MSG_WARN([Cannot locate qacct])
fi


##########
## Check SGE's mode (regular or Enterprise Edition)
##
$QHOST -help> $JUNK
SGE_MODE=`$AWK 'BEGIN {getline; print \$1}' < $JUNK`
SGE_RELEASE=`$AWK 'BEGIN {getline; print \$2}' < $JUNK`
if test "$SGE_MODE" != "SGE" -a "$SGE_MODE" != "SGEEE" ; then
   AC_MSG_WARN([Could not determine Grid Engine's mode. Assuming SGE])
   SGE_MODE=SGE
fi
AC_SUBST(SGE_MODE,$SGE_MODE)
AC_SUBST(SGE_RELEASE,$SGE_RELEASE)


##########
## Cleaning up junk file
##
/bin/rm -f $JUNK


##########
## Required epilog - update scheduler specific module
##
prefix='$(GLOBUS_LOCATION)'
exec_prefix='$(GLOBUS_LOCATION)'
libexecdir=${prefix}/libexec


##########
##
##
AC_OUTPUT(
    sge.pm:sge.in
)
