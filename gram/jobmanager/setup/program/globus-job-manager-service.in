#! @PERL@

BEGIN
{
    push(@INC, "@GLOBUS_LOCATION@/lib/perl");
    $ENV{GLOBUS_LOCATION} = "@GLOBUS_LOCATION@" if(!exists($ENV{GLOBUS_LOCATION}));
}

use Getopt::Long;
use IO::File;
use File::Copy;

my $servicename = 'jobmanager';
my $method = 'fork';
my $add = 0;
my $remove = 0;
my $help = 0;
my $force = 0;
my $gpath;

my $globusdir	= $ENV{GLOBUS_LOCATION};
my $libexecdir	= "$globusdir/libexec";
my $sysconfdir	= "$globusdir/etc";
my $servicesdir	= "$sysconfdir/grid-services";
my $setupdir = "$globusdir/setup/globus";
my $job_manager_conf = "$sysconfdir/globus-job-manager.conf";
my $perljmdir = "$globusdir/lib/perl/Globus/GRAM/JobManager";

GetOptions('service-name|s=s' => \$servicename,
           'manager-type|m=s' => \$manager_type,
	   'extra-config|e=s' => \$extra_config,
	   'add' => \$add,
	   'remove' => \$remove,
	   'jobmanager-config|j=s' => \$job_manager_conf,
	   'service-directory|d=s' => \$servicesdir,
	   'help|h' => \$help);

&usage() if $help;

if ( $remove && $add )
{
    print STDERR "Cannot have add and remove in the same command.\n";
    exit 2;
}

if ( !$remove && !$add )
{
    print STDERR "Either -add or -remove are required.\n";
    exit 2;
}

if(! &valid_manager_type($manager_type))
{
    print STDERR "Invalid job manager type $manager type.\n";
    exit 2;
}

if(! -d $servicesdir)
{
    print "Creating grid services directory.\n";
    mkdir $servicesdir, 0777;
}

if( $add )
{
   &create_services_file("$servicesdir/$servicename");
   copy("${setupdir}/${manager_type}.pm", "${perljmdir}/");
}
else
{
   system("rm $servicesdir/$servicename");
}


sub create_services_file
{
    my $filename = shift;
    my $service_file = new IO::File(">$filename");

    if(!defined($service_file))
    {
	print STDERR
	    "ERROR: Can't create services file $filename}.\n";
	exit 4;
    }
    print $service_file "stderr_log,local_cred - ".
                    "${libexecdir}/globus-job-manager globus-job-manager ".
		    "-conf ${job_manager_conf} -type ${manager_type} ".
		    "-rdn ${servicename} -machine-type unknown ".
		    "-publish-jobs $extra_config\n";

    $service_file->close();
}

sub usage
{
    print "Usage: $0 [-service-name|-s service_name]\n".
          "          [-manager-type|-m manager_type]\n".
	  "          [-jobmanager-config|-j CONFIG FILE]\n".
	  "          [-service-directory|-d DIRECTORY]\n".
          "          [-extra-config EXTRA]\n".
          "          [-add]\n".
          "          [-remove]\n".
          "          [-force]\n".
          "          [-help]\n";
    exit 1;
}

sub valid_manager_type
{
    my $name = $_[0];

    if("${setupdir}/${name}.pm")
    {
	return 1;
    }
    else 
    {
	return 0;
    }
}
