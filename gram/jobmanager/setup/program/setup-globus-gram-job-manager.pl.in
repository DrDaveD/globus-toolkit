#! /usr/bin/perl
#
# Copyright 1999-2010 University of Chicago
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
# http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

@GLOBUS_PERL_INITIALIZER@

use Getopt::Long;
use IO::File;
use Globus::Core::Paths;
use POSIX;
require Grid::GPT::Setup;

my $metadata =
    new Grid::GPT::Setup(package_name => "globus_gram_job_manager_setup");


my $setupdir	= "$Globus::Core::Paths::exec_prefix/setup/globus";
my $sysconfdir	= "$Globus::Core::Paths::sysconfdir";
my $libexecdir	= "$Globus::Core::Paths::libexecdir";
my $bindir	= "$Globus::Core::Paths::bindir";
my $sbindir	= "$Globus::Core::Paths::sbindir";
my $state_dir   = "$globusdir/tmp/gram_job_state";
my $help	= 0;
my $auditing_dir = '';   

GetOptions('state-dir|s=s' => \$state_dir,
           'auditing-dir|a=s' => \$auditing_dir,
           'help|h' => \$help);

&usage if($help);

&setup_state_dir();
if ($auditing_dir ne '')
{
    &setup_audit_dir();
}
&setup_job_manager_conf();
print "Done\n";

$metadata->finish();

sub setup_state_dir
{
    my $last_built_path = '';
    my $built_path = '';
    my @components;

    print "Creating state file directory.\n";

    if( $state_dir !~ m|^/|)
    {
	print STDERR "Invalid directory for state files \"$state_dir\"\n";
	exit(1);
    }

    @components = split(/\//, $state_dir);

    foreach(@components)
    {
	next if $_ eq '';

	$last_built_path = $built_path;
	$built_path .= "/$_";

	if(-e $built_path && ! -d $built_path)
	{
	    print STDERR "Invalid path for state files: " .
	                 "$built_path is not a directory\n";
	    exit(1);
	}
	elsif(! -e $built_path)
	{
	    my $fs_type;

	    mkdir($built_path, 0755) ||
                die "Unable to create directory $built_path\n";
	}
    }
    
    if((stat($state_dir))[2] != 01777)
    {
        chmod(01777, $state_dir) || die "Can't set permissions on $state_dir\n";
    }
    print "Done.\n";

    print "Checking if state directory supports POSIX file locking... ";
    $rc = system("$Globus::Core::Paths::libexecdir/globus-job-manager-lock-test $state_dir/lock_test");
    if ($rc)
    {
        die "no\n";
    }
    print "yes\n";

}

sub setup_audit_dir
{
    my $last_built_path = '';
    my $built_path = '';
    my @components;

    print "Creating auditing file directory.\n";

    if( $auditing_dir !~ m|^/|)
    {
	print STDERR "Invalid directory for audit files \"$auditing_dir\"\n";
	exit(1);
    }

    @components = split(/\//, $auditing_dir);

    foreach(@components)
    {
	next if $_ eq '';

	$last_built_path = $built_path;
	$built_path .= "/$_";

	if(-e $built_path && ! -d $built_path)
	{
	    print STDERR "Invalid path for state files: " .
	                 "$built_path is not a directory\n";
	    exit(1);
	}
	elsif(! -e $built_path)
	{
	    mkdir($built_path, 0777) ||
                die "Unable to create directory $built_path\n";
	    chmod(0755, $built_path) ||
	        die "Can't set permissions on $built_path\n";
	}
    }
    
    # Desired permissions: drwx-wx-wt 
    if((stat($auditing_dir))[2] != 05733)
    {
        chmod(05733, $auditing_dir) || die "Can't set permissions on $auditing_dir\n";
    }

    print "Done.\n";
}

sub setup_job_manager_conf
{
    my ($gatekeeper_port, $gatekeeper_subject) = (0, "unknown");
    my ($hostname, $cpu, $manufacturer, $os_name, $os_version);
    my ($toolkit_version);
    my $jm_conf	= "${sysconfdir}/globus-job-manager.conf";
    my $conf_file;
    my $toolkit_version = `${bindir}/globus-version` || "unknown";

    chomp($toolkit_version);


    ($gatekeeper_subject, $gatekeeper_port) =
	&get_gatekeeper_info("${sysconfdir}/globus-gatekeeper.conf");

    ($hostname, $cpu, $manufacturer, $os_name, $os_version) = &get_system_info();

    print "Creating job manager configuration file...\n";
    $conf_file = new IO::File(">$jm_conf") || die "open failed for $jm_conf";

    print $conf_file <<EOF;
	-home \"$globusdir\"
	-globus-gatekeeper-host $hostname
	-globus-gatekeeper-port $gatekeeper_port
	-globus-gatekeeper-subject \"$gatekeeper_subject\"
	-globus-host-cputype $cpu
	-globus-host-manufacturer $manufacturer
	-globus-host-osname $os_name
	-globus-host-osversion $os_version
        -globus-toolkit-version $toolkit_version
	-stdio-log \"\$(HOME)\"
        -log-levels 'FATAL|ERROR'
	-state-file-dir $state_dir
EOF
    if ($auditing_dir ne '')
    {
        print $conf_file "-audit-directory $auditing_dir\n";
    }
    $conf_file->close();
}

sub get_gatekeeper_info
{
    my ($gatekeeper_conf_filename) = $_[0];
    my ($host_cert_file, $subject, $port) = ();
    my $grid_cert_info = "$Globus::Core::Paths::bindir/grid-cert-info";

    $port = 0;
    if (-f "$gatekeeper_conf_filename")
    {
        print "Reading gatekeeper configuration file...\n";

        chomp($host_cert_file = `. $gatekeeper_conf_filename ; echo $GLOBUS_GATEKEEPER_CERT_FILE`);

        if ($host_cert_file eq '')
        {
            print "No certificate named in gatekeeper configuration file, checking default cert...\n";
            $host_cert_file = "/etc/grid-security/hostcert.pem";
        }

        chomp($port = `. $gatekeeper_conf_filename ; echo $GLOBUS_GATEKEEPER_PORT`);
        if ($port eq '')
        {
            $port = 0;
        }
        else
        {
            $port = int($port);
        }
    }

    if (-r $host_cert_file)
    {
        chomp($subject = `$grid_cert_info -subject -file \"$host_cert_file\"`);
    }
    else
    {
	print STDERR <<EOF;
Warning: Host cert file: $host_cert_file not found.  Re-run
         setup-globus-gram-job-manager after installing host cert file.
EOF
        $subject = 'unknown';
    }
    $subject =~ s/^\s+//; #strip leading whitespace

    return ($subject, $port);
}

sub get_system_info
{
    my ($hostname, $cpu, $manufacturer, $os_name, $os_version);
    my @uname_data;

    print "Determining system information...\n";
    chomp($hostname = `${bindir}/globus-hostname`);
    ($cpu, $manufacturer) = (split(/-/, `${libexecdir}/config.guess`))[0,1];

    @uname_data = POSIX::uname();

    $os_name = $uname_data[0];

    $os_version="";

    if($os_name eq "AIX")
    {
       $os_version = $uname_data[3] . ".";
    }

    $os_version .= $uname_data[2];

    return ($hostname, $cpu, $manufacturer, $os_name, $os_version);
}

sub usage
{
    print "Usage: $0 [options]\n".
    "Options:  [--state-dir|-s DIR]\n".
    "          [--auditing-dir|-a DIR]\n".
    "          [--help|-h]\n";
    exit 1;
}
