#! /bin/sh
#
# Cancel a NQE job.
#

. ${GLOBUS_LOCATION}/libexec/globus-script-initializer

globus_source ${libexecdir}/globus-gram-protocol-constants.sh
globus_source ${libexecdir}/globus-sh-tools.sh
globus_source ${libexecdir}/globus-gram-job-manager-tools.sh

#Site specfic values:
#######################
qdel=${GLOBUS_GRAM_JOB_MANAGER_QDEL-qdel}
grep=${GLOBUS_GRAM_JOB_MANAGER_GREP-grep}

arg_file=$1

# check for the argument file if it does not exist
# then return with an error immediately.
if [ ! -f $arg_file ] ; then
   echo GRAM_SCRIPT_ERROR:$GLOBUS_GRAM_PROTOCOL_ERROR_BAD_SCRIPT_ARG_FILE
   exit 1
fi
 
# use the argument file to define all the arguments
. $arg_file
 
# if a logfile has been passed in then assume debug mode.
if [ $grami_logfile = "/dev/null" ] ; then
    DEBUG_ECHO=:
else
    DEBUG_ECHO=echo
fi
 
$DEBUG_ECHO "JM_SCRIPT: in nqe_rm" >> $grami_logfile
 
$DEBUG_ECHO "JM_SCRIPT: executing qdel -k with job id "\
            "${grami_job_id}" >> $grami_logfile

status=`${qdel} -k ${grami_job_id} | $grep "Deleted by"`
 
if [ "${status}x" = "x" ] ; then
    echo GRAM_SCRIPT_ERROR:$GLOBUS_GRAM_PROTOCOL_ERROR_JOB_CANCEL_FAILED
else
#   the job manager only cares about GRAM_SCRIPT_SUCCESS or
#   GRAM_SCRIPT_ERROR from this script.  The value is inconsiquencial.
    echo GRAM_SCRIPT_SUCCESS:999
fi
 
$DEBUG_ECHO "JM_SCRIPT: exiting nqe_rm" >> $grami_logfile
