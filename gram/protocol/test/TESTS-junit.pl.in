#! /usr/bin/env perl

BEGIN { push(@INC, $ENV{GLOBUS_LOCATION} . "/lib/perl"); }

use strict;
use TAP::Harness::Junit;
use Cwd;
require 5.005;
use vars qw(@tests);
use Globus::Testing::Utilities;

my $test_result=1;

$|=1;

my $globus_location = $ENV{GLOBUS_LOCATION};
my $contact;

@tests = qw(
    globus-gram-protocol-allow-attach-test.pl
    globus-gram-protocol-error-test.pl
    globus-gram-protocol-io-test.pl
    globus-gram-protocol-pack-test.pl
    pack-with-extensions-test.pl
    create-extensions-test.pl
    unpack-message-test.pl
    unpack-with-extensions-test.pl
    unpack-job-request-reply-with-extensions-test.pl
    unpack-status-reply-with-extensions-test.pl
);

chdir "$globus_location/test/@PACKAGE@";

if(0 != system("grid-proxy-info -exists -hours 2 2>/dev/null") / 255)
{
    Globus::Testing::Utilities::testcred_setup();
}

my $harness = TAP::Harness::JUnit->new({
    xmlfile => 'globus-gram-protocol-test.xml',
    merge => 1
});
$test_result = eval { $harness->runtests(@tests); };

if(!defined($test_result))
{
    print $@;
    $test_result=1;
}
else
{
    $test_result=0;
}

exit($test_result);
