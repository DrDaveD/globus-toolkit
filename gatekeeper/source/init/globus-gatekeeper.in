#! /bin/sh
#
# Copyright 1999-2010 University of Chicago
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
# http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

GLOBUS_GATEKEEPER_CONFIG=${GLOBUS_GATEKEEPER_CONFIG:-@GATEKEEPER_CONFIGDIR@/@GATEKEEPER_CONFIGFILE@}
test -f "${GLOBUS_GATEKEEPER_CONFIG}" && . "${GLOBUS_GATEKEEPER_CONFIG}"

test -f ${GLOBUS_LOCATION:-@sbindir@}${GLOBUS_LOCATION:+/sbin}/globus-gatekeeper || exit 0

GLOBUS_GATEKEEPER_PIDFILE="${GLOBUS_GATEKEEPER_PIDFILE:-@localstatedir@/run/globus-gatekeeper.pid}"
GLOBUS_GATEKEEPER_PORT="${GLOBUS_GATEKEEPER_PORT:-2119}"


case "$1" in
    start)

        if [ "${GLOBUS_GATEKEEPER_KERBEROS_ENABLED:-false}" = "true" ]; then
            kflag="-k"
        else
            kflag=""
        fi

        ${GLOBUS_LOCATION:-@sbindir@}${GLOBUS_LOCATION:+/sbin}/globus-gatekeeper \
            -pidfile ${GLOBUS_GATEKEEPER_PIDFILE} \
            ${GLOBUS_GATEKEEPER_PORT:+-p ${GLOBUS_GATEKEEPER_PORT}} \
            ${GLOBUS_GATEKEEPER_LOG:+-l "${GLOBUS_GATEKEEPER_LOG}"} \
            ${GLOBUS_GATEKEEPER_GRID_SERVICES:+-grid_services "${GLOBUS_GATEKEEPER_GRID_SERVICES}"} \
            ${GLOBUS_GATEKEEPER_GRIDMAP:+-gridmap "${GLOBUS_GATEKEEPER_GRIDMAP}"} \
            ${GLOBUS_GATEKEEPER_CERT_DIR:+-x509_cert_dir "${GLOBUS_GATEKEEPER_CERT_DIR}"} \
            ${GLOBUS_GATEKEEPER_CERT_FILE:+-x509_user_cert "${GLOBUS_GATEKEEPER_CERT_FILE}"} \
            ${GLOBUS_GATEKEEPER_KEY_FILE:+-x509_user_key "${GLOBUS_GATEKEEPER_KEY_FILE}"} \
            $kflag \
            ${GLOBUS_GATEKEEPER_KMAP:+-globuskmap "${GLOBUS_GATEKEEPER_KMAP}"}

        if ! test -f "${GLOBUS_GATEKEEPER_PIDFILE}"; then
            sleep 1
        fi

        if test -f "${GLOBUS_GATEKEEPER_PIDFILE}"; then
            pid=`cat "${GLOBUS_GATEKEEPER_PIDFILE}"` 
            if kill -0 "$pid" 2> /dev/null; then
                echo "Started globus-gatekeeper"
                exit 0
            fi
        else
            echo "Error starting globus-gatekeeper"
            exit 1
        fi
        ;;

    stop)
        if test -f "${GLOBUS_GATEKEEPER_PIDFILE}"; then
            pid="`cat \"${GLOBUS_GATEKEEPER_PIDFILE}\"`"
            if [ "$pid" -gt 0 ] 2> /dev/null; then
                kill -TERM "${pid}"
                sleep 1
                if ! kill -0 "${pid}" 2> /dev/null; then
                    rm "${GLOBUS_GATEKEEPER_PIDFILE}"
                    echo "Stopped globus-gatekeeper"
                    exit 0
                else
                    echo "Failed to stop globus-gatekeeper"
                    exit 1
                fi
            else
                rm "${GLOBUS_GATEKEEPER_PIDFILE}"
                echo "Removed stale pidfile"
                exit 0
            fi
        else
            echo "No globus-gatekeeper running"
            exit 0
        fi
        ;;

    restart)
        $0 stop
        $0 start
        ;;

    force-reload)
        $0 restart
        ;;
esac
