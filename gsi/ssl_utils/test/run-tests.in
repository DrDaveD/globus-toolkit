#! /bin/sh
# run_tests
TEST_EXECS="@TEST_EXECS@"
srcdir=@srcdir@

echo "Running tests in `${GLOBUS_SH_PWD-pwd}`"
all_successful=1

if [ $# -lt 2 -a "$1" != "local" ]; then
    echo "syntax: run-tests local|<globusrun path> <gatekeeper> <extra RSL>" 1>&2
    exit 1
fi

for testfile in ""$TEST_EXECS; do
    if [ -z "$testfile" ]; then
	:
    else
        if [ -x "${testfile}" ] ; then
	    echo "----"
	    echo "Executing test ${testfile}"
    
            if [ "$1" = "local" ]; then
                ./${testfile} > ${testfile}.out 2> ${testfile}.err
            else
   	        "$1" "-s" "-r" "$2" "&(executable=${testfile})
			 	    (directory=`pwd`)
			 	    $3" > ${testfile}.out 2> ${testfile}.err
            fi

	    ${GLOBUS_SH_DIFF-diff} -b ${testfile}.out ${srcdir}/${testfile}.stdout
	    rc1=$?
	    ${GLOBUS_SH_DIFF-diff} -b ${testfile}.err ${srcdir}/${testfile}.stderr
	    rc2=$?
	    if [ $rc1 -ne 0 ] || [ $rc2 -ne 0 ]; then
	        echo "***There were differences***"
                all_successful=0
	    else
	        echo "Test successful"
	    fi
        else
	    echo "**Missing test $testfile***"
        fi
    fi
done

if [ $all_successful -eq 0 ]; then
    append="Some tests failed"
else
    append="tests successful"
fi
echo "$append"
echo "----"
