#ifndef GLOBUS_DONT_DOCUMENT_INTERNAL
/**
 * @file globus_error_openssl.c
 *
 * $RCSfile$
 * $Revision$
 * $Date$
 */
#endif

#include "globus_i_error_openssl.h"
#include "globus_i_error_generic.h"
#include <string.h>

/**
 * @name Get OpenSSL Error
 */
/* @{ */
/**
 * Get the OpenSSL error and create a
 * wrapped globus error object from
 * the error.
 *
 * @param base_source
 *        The module that the error was generated from
 * @return The globus error object.  A globus_result_t
 *         object can be created using the globus_error_put
 *         function
 *
 * @see globus_error_put()
 */
globus_object_t *
globus_error_get_openssl_error(
    globus_module_descriptor_t *        base_source,
    char *                              openssl_error,
    int                                 error_type,
    char *                              error_description)
{
    unsigned long                       error_code;
    char *                              filename;
    int                                 linenumber;

    error_code = ERR_get_error_line(&filename, &linenumber);

    if(error_code == 0)
    {
        return globus_error_construct_error(
            base_source,
            NULL,
            error_type,
            openssl_error,
            "GSI Proxy expected an OpenSSL error.  OpenSSL Error NOT FOUND");
    }
            
    return globus_error_wrap_openssl_error(
        base_source, 
        error_code,
        filename,
        linenumber,
        openssl_error,
        error_type,
        error_description);
}

/**
 * @name Wrap OpenSSL Error
 */
/* @{ */
/**
 * Wrap an openssl error in a globus error object
 *
 * @param base_source
 *        The module the error was generated in
 * @param error_code
 *        The error code generated by the openssl error
 * @param filename
 *        The openssl filename where the error occurred
 * @param linenumber
 *        The openssl line number where the error occurred
 * @return
 *        The resulting globus error object
 */
globus_object_t *
globus_error_wrap_openssl_error(
    globus_module_descriptor_t *        base_source,
    const unsigned long                 error_code,
    const char *                        filename,
    const int                           linenumber,
    char *                              openssl_error,
    int                                 error_type,
    char *                              error_description)
{
    globus_object_t *                   causal_error;

    causal_error = globus_error_construct_string(
        base_source,
        NULL,
        "OpenSSL Error: %s:%s: %s in %s:%d",
        ERR_lib_error_string(error_code),
        ERR_func_error_string(error_code),
        ERR_reason_error_string(error_code),
        filename,
        linenumber);

    if(!causal_error)
    {
        return GLOBUS_NULL;
    }

    return globus_error_construct_error(
        base_source, 
        causal_error, 
        error_type,
        openssl_error,
        error_description);
}
